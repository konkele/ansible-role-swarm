global_defs {
    enable_script_security
    router_id {{ inventory_hostname }}
    script_user {{ keepalived_script_user }} {{ keepalived_script_user_group }}
}

{% for script in keepalived_scripts %}
vrrp_script {{ script.name }} {
    script "{{ script.script }}"
    interval {{ script.interval }}
    timeout {{ script.timeout }}
    fall {{ script.fall }}
    rise {{ script.rise }}
    weight {{ script.weight }}
}
{% endfor %}

{% for instance in keepalived_instances %}
vrrp_instance {{ instance.name }} {
    state BACKUP
    interface {{ instance.interface }}
    virtual_router_id {{ instance.vrid }}
    priority {{ instance.priority }}
    advert_int {{ instance.advert_int }}

    authentication {
        auth_type PASS
        auth_pass {{ instance.auth_pass[:8] }}   # truncate to 8 chars
    }

    virtual_ipaddress {
        {% for vip in instance.vips %}
        {{ vip.address }}/{{ vip.cidr }} dev {{ instance.interface }}
        {% endfor %}
    }

    track_script {
        {% for script_name in instance.track_scripts %}
        {{ script_name }}
        {% endfor %}
    }
}
{% endfor %}
